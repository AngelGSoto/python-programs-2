'''
Getting the PNe from S-PLUS catalog (DR2)
'''
from __future__ import print_function
from astropy.io import fits
import numpy as np
import glob
import json
import matplotlib.pyplot as plt
import seaborn as sns
import sys
from astropy.table import Table
import argparse
from io import StringIO
import os

n=129
mag_aper = [[] for _ in range(n)]
mag_petro = [[] for _ in range(n)]
mag_auto = [[] for _ in range(n)]

def select(magg):
    ef1 = dta['euJAVA_'+magg] <= 3.0
    ef2 = dta['eF378_'+magg] <= 3.0
    ef3 =  dta['eF395_'+magg] <= 3.0
    ef4 =  dta['eF410_'+magg] <= 3.0
    ef5 =  dta['eF430_'+magg] <= 3.0
    ef6 =  dta['eg_'+magg] <= 3.0
    ef7 =  dta['eF515_'+magg] <= 3.0
    ef8 =  dta['er_'+magg] <= 0.2
    ef9 =  dta['eF660_'+magg] <= 0.2
    ef10 =  dta['ei_'+magg] <= 0.2
    ef11 =  dta['eF861_'+magg] <= 3.0
    ef12 =  dta['ez_'+magg] <= 3.0

    mask = ef1 & ef2 & ef3 & ef5 & ef6 & ef7 & ef8 & ef9 & ef10 & ef11 & ef12
    #mask = ef8 & ef9 & ef10 
    
    #Mask
    #Mask filters
    #q = (dta['F515_'+magg] - dta['F660_'+magg]) <= 5.0
    #q1 = (data['J0515'] - data['J0861']) >= -3.0
    q2 = (dta['r_'+magg] - dta['F660_'+magg]) <= 4.0
    q3 = (dta['r_'+magg] - dta['i_'+magg]) >= -4.0
    #q4 = (dta['g_'+magg] - dta['F515_'+magg]) >= -3.2
    #q5 = (dta['g_'+magg] - dta['i_'+magg]) >= -3.0
    #q6 = (dta['F410_'+magg] - dta['F660_'+magg]) <= 6.0
    #q7 = (dta['z_'+magg] - dta['g_'+magg]) <= 4.0

    mask1 =  q2 & q3 
    #Mask
    Y = 2.7*(dta['F515_'+magg] - dta['F861_'+magg]) + 2.15
    Y1 = 0.2319*(dta['z_'+magg] - dta['g_'+magg]) + 0.85
    Y2 = -1.3*(dta['z_'+magg] - dta['g_'+magg]) + 1.7
    Y3 = 1.559*(dta['F660_'+magg] - dta['r_'+magg]) + 0.58
    Y4 = 0.12*(dta['F660_'+magg] - dta['r_'+magg]) - 0.01
    Y44 = -1.1*(dta['F660_'+magg] - dta['r_'+magg]) - 1.07
    Y5 = 8.0*(dta['g_'+magg] - dta['i_'+magg]) + 4.5
    Y6 = 0.8*(dta['g_'+magg] - dta['i_'+magg]) + 0.55
    Y7 = 0.43*(dta['r_'+magg] - dta['i_'+magg]) + 0.65
    Y8 = -6.8*(dta['r_'+magg] - dta['i_'+magg]) - 1.3

    m = dta['PhotoFlag'] == 0.0
    #m = data['Class star'] > 0.0 
    m1 = dta['F660_'+magg] - dta['r_'+magg]<=-1.0 
    m2 = dta['F515_'+magg] - dta['F660_'+magg]>=0.3
    m3 = dta['z_'+magg] - dta['F660_'+magg]>=Y1
    m4 = dta['z_'+magg] - dta['F660_'+magg]>=Y2
    m5 = dta['F515_'+magg] - dta['F660_'+magg]>=Y
    m6 = dta['F660_'+magg] - dta['g_'+magg]>=Y3
    m7 = dta['g_'+magg] - dta['F515_'+magg]<=Y4
    m8 = dta['g_'+magg] - dta['F515_'+magg]<=Y44
    m9 = dta['F410_'+magg] - dta['F660_'+magg]>=Y5
    m10 = dta['F410_'+magg] - dta['F660_'+magg]>=Y6
    m11 = (dta['r_'+magg] - dta['F660_'+magg]) >= Y7
    m12 = (dta['r_'+magg] - dta['F660_'+magg]) <= Y8
    total_m = m1 & m2 & m3 & m4 & m5 & m6 & m7 & m8 & m9 & m10 & m11 & m12 & mask #& mask1
    
    table = Table(dta[total_m])
    return table

   
parser = argparse.ArgumentParser(
    description="""Make a table from the S-PLUS catalogs """)

parser.add_argument("source", type=str,
                    default="teste-program",
                    help="Name of catalog, taken the prefix ")

cmd_args = parser.parse_args()
fitsfile = cmd_args.source + ".fits"
hdulist= fits.open(fitsfile, dtype='uint8', mode='denywrite', memmap=True)
dta = hdulist[1].data
# m = dta['PhotoFlag'] == 0.0
# print(dta[m])

table_aper = select('aper')
table_petro = select('petro')
table_auto = select('auto')

# # #Saving resultated table
#######
#aper#
#######
asciifile = fitsfile.replace(".fits", "-aper-PN.tab")
try:
    table_aper.write(asciifile, format='ascii.tab', overwrite=True)
except TypeError:
    table_aper.write(asciifile, format='ascii.tab')

#######
#petro#
#######
asciifile_petro = fitsfile.replace(".fits", "-petro-PN.tab")
try:
    table_petro.write(asciifile_petro, format='ascii.tab', overwrite=True)
except TypeError:
    table_petro.write(asciifile_petro, format='ascii.tab')

######
#auto#
######
asciifile_auto = fitsfile.replace(".fits", "-auto-PN.tab")
try:
    table_auto.write(asciifile_auto, format='ascii.tab', overwrite=True)
except TypeError:
    table_auto.write(asciifile_auto, format='ascii.tab')
